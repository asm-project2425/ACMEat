<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Vehicle Tracker</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
</head>

<body>

<!-- Modal -->
<div class="modal fade" id="deliveryModal" tabindex="-1" aria-labelledby="deliveryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deliveryModalLabel">Consegna <span id="deliveryId"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Ordine: </strong><span id="orderId"></span></p>
                <p><strong>Stato: </strong><span id="status"></span></p>
                <p><strong>Costo: </strong><span id="cost"></span>&euro;</p>
                <p><strong>Orario: </strong><span id="time"></span></p>
                <p><strong>Indirizzo locale: </strong><span id="localAddress"></span></p>
                <p><strong>Indirizzo cliente: </strong><span id="clientAddress"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<header>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Vehicle Tracker</a>
        </div>
    </nav>
</header>

<main class="container mt-5">

    <div class="row">
        <div class="col-12 text-center">
            <h1>Veicoli</h1>
        </div>
    </div>

    <div class="row mt-4" id="vehicles">
        <template id="vehicleTemplate">
            <div class="col-3 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h3 class="card-title text-center">Veicolo <span class="vehicleId"></span></h3>
                        <p class="card-text"><strong>Stato: </strong><span class="vehicleStatus"></span></p>
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#deliveryModal"></button>
                    </div>
                </div>
            </div>
        </template>
    </div>
</main>

<script>
    const vehicleTrackerURL = 'http://localhost:5002/api/v1/vehicles';

    const vehiclesRow = document.getElementById("vehicles");
    const vehiclesTemplate = document.getElementById("vehicleTemplate");

    const deliveryModal = document.getElementById('deliveryModal');
    const deliveryId = document.getElementById('deliveryId');
    const orderId = document.getElementById('orderId');
    const status = document.getElementById('status');
    const cost = document.getElementById('cost');
    const time = document.getElementById('time');
    const localAddress = document.getElementById('localAddress');
    const clientAddress = document.getElementById('clientAddress');

    deliveryModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        deliveryId.textContent = button.getAttribute('data-bs-delivery-id');
        orderId.textContent = button.getAttribute('data-bs-order-id');
        status.textContent = button.getAttribute('data-bs-status');
        cost.textContent = button.getAttribute('data-bs-cost');
        time.textContent = button.getAttribute('data-bs-time');
        localAddress.textContent = button.getAttribute('data-bs-local-address');
        clientAddress.textContent = button.getAttribute('data-bs-client-address');
    });

    async function fetchVehicles() {
        try {
            const res = await fetch(vehicleTrackerURL);
            if (!res.ok) {
                throw await res.text();
            }
            const vehicles = await res.json();

            vehiclesRow.replaceChildren(); // Clear vehicles

            for (const vehicle of vehicles) {
                const cloned = vehiclesTemplate.content.cloneNode(true);
                cloned.querySelector('.vehicleId').textContent = vehicle.id;
                cloned.querySelector('.vehicleStatus').textContent = prettifyVehicleStatus(vehicle.status);
                const button = cloned.querySelector('button');
                if (vehicle.current_delivery == null) {
                    button.disabled = true;
                    button.textContent = 'Nessuna consegna';
                } else {
                    button.textContent = 'Visualizza consegna';
                    button.setAttribute('data-bs-delivery-id', vehicle.current_delivery.delivery_id);
                    button.setAttribute('data-bs-order-id', vehicle.current_delivery.order_id);
                    button.setAttribute('data-bs-status', prettifyDeliveryStatus(vehicle.current_delivery.status));
                    button.setAttribute('data-bs-cost', vehicle.current_delivery.cost);
                    button.setAttribute('data-bs-time', new Date(vehicle.current_delivery.time).toLocaleString());
                    button.setAttribute('data-bs-local-address', vehicle.current_delivery.local_address);
                    button.setAttribute('data-bs-client-address', vehicle.current_delivery.client_address);
                }
                vehiclesRow.appendChild(cloned);
            }
        } catch (e) {
            console.error('Error fetching vehicles:');
            console.error(e);
        }

        setTimeout(fetchVehicles, 1000 * 5); // Every five seconds
    }

    fetchVehicles();

    function prettifyVehicleStatus(status) {
        switch (status) {
            case 'available':
                return 'Disponibile';
            case 'in_use':
                return 'In uso';
            default:
                return status;
        }
    }

    function prettifyDeliveryStatus(status) {
        switch (status) {
            case 'created':
                return 'Creato';
            case 'confirmed':
                return 'Confermato';
            case 'cancelled':
                return 'Cancellato';
            case 'delivering':
                return 'In consegna';
            case 'delivered':
                return 'Consegnato';
            case 'completed':
                return 'Completato';
            default:
                return status;
        }
    }
</script>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
</body>
</html>
